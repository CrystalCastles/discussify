import Head from "next/head";
import {
  useSupabaseClient,
  useSession,
} from "@supabase/auth-helpers-react";
import { useEffect, useState } from "react";
import CuratedResults from "../components/CuratedResults";
import nookies from 'nookies';
import { parseCookies, setCookie, destroyCookie } from 'nookies';

export default function Home() {
  const supabase = useSupabaseClient();
  const session = useSession();
  // console.log(session)
  const [recentlyPlayed, setRecentlyPlayed] = useState();
  const [recentlyCommented, setCommented] = useState();
  const [newReleases, setNewReleases] = useState();
  // const [token, setToken] = useState();
  nookies.set(null, 'Testing2', 'test2');
  const cookies = parseCookies()
  console.log({ cookies })

  useEffect(() => {
    getRecentlyCommentedOn();
  }, []);

  useEffect(() => {
    if(session) {
      if (typeof window !== 'undefined') {
        // Perform localStorage action
        if(!localStorage.getItem('__spotifyToken')) {
          localStorage.setItem('__spotifyToken', session.provider_token);
        }
        if(!localStorage.getItem('__spotifyRefreshToken')) {
          localStorage.setItem('__spotifyRefreshToken', session.provider_refresh_token);
        }
      }
      // setToken(session.provider_token);
    }
  }, [session]);

  useEffect(() => {
    if (typeof window !== 'undefined') {
      // Perform localStorage action
      if(localStorage.getItem('__spotifyToken')) {
        getSpotifyData(localStorage.getItem('__spotifyToken'));
      }
    }
  }, []);

  async function signInWithSpotify() {
    try {
      const { error, data } = await supabase.auth.signInWithOAuth(
        {
          provider: "spotify",
          options: {
            scopes: "user-read-recently-played",
            // queryParams: {
            //   show_dialog: true,
            // },
          }
        },
      );
      if(data) {
        console.log(data)
      }
      else if (error) {
        alert("Error with auth: " + error.message);
      }
    } catch {
      console.log("error", error);
      alert(error.error_description || error);
    }
  }

  async function getRecentlyPlayed(token) {
    return fetch("/api/spotify", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        token,
        recent: true
      })
    }).then(async (response) => {
      if (response.ok) {
        const data = await response.json();
        setRecentlyPlayed(data);
      } else {
        setRecentlyPlayed(null);
        return response.status;
      }
    });
  }

  async function getRecentlyCommentedOn() {
    fetch("/api/comments/retrieve", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        recentlyCommentedOn: true
      })
    }).then(async (response) => {
      if (response.ok) {
        const data = await response.json();
        setCommented(data);
      } else {
        setCommented(null);
      }
    });
  }

  async function getNewReleases(token) {
    fetch("/api/spotify", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        token,
        newReleases: true
      })
    }).then(async (response) => {
      if (response.ok) {
        const data = await response.json();
        setNewReleases(data);
      } else {
        setNewReleases(null);
      }
    });
  }

  async function getSpotifyData(token) {
    let recentlyPlayedStatus = await getRecentlyPlayed(token);
    if(recentlyPlayedStatus === 401) {
      return fetch("/api/spotify", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          refreshToken: localStorage.getItem('__spotifyRefreshToken'),
        })
      }).then(async (response) => {
        if (response.ok) {
          const data = await response.json();
          localStorage.setItem('__spotifyToken', data.access_token);
          return getSpotifyData(data.access_token);
        } else {
          console.log("Error refreshing token.")
        }
      });
    }
    await getNewReleases(token);
  }

  return (
    <>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main className="bg-mainBlack pt-12 min-h-screen">
        {session ? (
          <div className="grid lg:grid-cols-1 xl:grid-cols-2 2xl:grid-cols-3 gap-10 xs:mx-5 overflow-hidden py-5">
            <div className="">
              <h1 className="text-white text-center text-2xl font-semibold">RECENTLY PLAYED</h1>
              { recentlyPlayed && <CuratedResults media={recentlyPlayed}/> }
            </div>
            <div className="">
              <h1 className="text-white text-center text-2xl font-semibold ml-5">RECENTLY ACTIVE</h1>
              { recentlyCommented && <CuratedResults media={recentlyCommented}/> }
            </div>
            <div className="">
              <h1 className="text-white text-center text-2xl font-semibold">NEW RELEASES</h1>
              { recentlyPlayed && <CuratedResults media={newReleases}/> }
            </div>
          </div>
        ) : (
          <div className="flex h-screen items-center justify-center">
            <div className="text-center">
              <h1 className="text-white">App Name</h1>
              <button
                className="text-s inline-block rounded-full bg-spotifyGreen px-8 py-3 font-medium leading-tight text-white shadow-md transition duration-150 ease-in-out hover:bg-green-600 hover:shadow-lg focus:bg-green-600 focus:shadow-lg focus:outline-none focus:ring-0 active:bg-green-700 active:shadow-lg"
                onClick={signInWithSpotify}
              >
                Log In with Spotify
              </button>
            </div>
          </div>
        )}
      </main>
    </>
  );
}